name: terraform

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    # Weekly snapshot for scorecards (Mondays 07:17 UTC)
    - cron: "17 7 * * 1"

permissions:
  contents: read

env:
  AWS_REGION: us-west-2
  TF_DIR: terraform
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_CLI_ARGS: "-no-color"

jobs:
  pr_checks:
    if: github.event_name == 'pull_request'
    name: PR Checks (fmt/validate)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Terraform fmt (check)
        working-directory: ${{ env.TF_DIR }}
        run: terraform fmt -check -recursive

      - name: Terraform init (no backend)
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: ${{ env.TF_DIR }}
        run: terraform validate

  plan_main:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    name: Plan (main)
    runs-on: ubuntu-latest
    concurrency:
      group: nvcd-infra-plan-apply
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}
      TF_VAR_origin_verify_header_value: ${{ secrets.NV_ORIGIN_VERIFY_SECRET }}
    steps:
      - uses: actions/checkout@v4

      - name: Show OIDC claims (safe)
        shell: bash
        run: |
          set -euo pipefail

          # Request an OIDC token with the AWS audience
          resp="$(curl -sSf -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com")"

          # Extract the JWT from the JSON response
          token="$(python3 - <<'PY'
import json,sys
print(json.loads(sys.stdin.read())["value"])
PY
<<< "$resp")"

          # Decode JWT payload and print only safe claim fields
          python3 - <<'PY'
import base64, json, sys
parts = sys.stdin.read().strip().split(".")
payload_b64 = parts[1]
payload_b64 += "=" * (-len(payload_b64) % 4)
payload = json.loads(base64.urlsafe_b64decode(payload_b64).decode())
print("aud:", payload.get("aud"))
print("sub:", payload.get("sub"))
print("job_workflow_ref:", payload.get("job_workflow_ref"))
PY
<<< "$token"

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::460742884765:role/nvc-github-terraform-deploy
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Terraform init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init

      - name: Terraform plan
        working-directory: ${{ env.TF_DIR }}
        run: terraform plan -out=tfplan

      - name: Render plan (text)
        working-directory: ${{ env.TF_DIR }}
        run: terraform show -no-color tfplan > tfplan.txt

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: |
            ${{ env.TF_DIR }}/tfplan
            ${{ env.TF_DIR }}/tfplan.txt
          if-no-files-found: error
          retention-days: 14

  apply_main:
    if: github.event_name == 'push'
    name: Apply (prod)
    runs-on: ubuntu-latest
    needs: [plan_main]
    concurrency:
      group: nvcd-infra-plan-apply
      cancel-in-progress: false
    environment: prod
    permissions:
      id-token: write
      contents: read
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}
      TF_VAR_origin_verify_header_value: ${{ secrets.NV_ORIGIN_VERIFY_SECRET }}
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::460742884765:role/nvc-github-terraform-deploy
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Terraform init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_DIR }}

      - name: Terraform apply (approved)
        working-directory: ${{ env.TF_DIR }}
        run: terraform apply -auto-approve tfplan

  telemetry_snapshot:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    name: Telemetry snapshot (Cloudflare â†’ S3)
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ZONE_TAG: ${{ vars.CLOUDFLARE_ZONE_ID }}
      TELEMETRY_BUCKET: ${{ vars.TELEMETRY_BUCKET }}
      DAYS: "7"
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::460742884765:role/nvc-github-terraform-deploy
          aws-region: ${{ env.AWS_REGION }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install --no-cache-dir boto3 requests

      - name: Run snapshot
        run: python scripts/cf_telemetry_snapshot.py
